<!DOCTYPE html>
<html>
<head>
    <title>Fusion Meta  – Stock Predictor Dashboard</title>
    <style>
        body { background-color: #1f1f2e; color: #e0e0e0; font-family: Arial; text-align:center; padding:20px; }
        h1 { color:#00bfff; }
        input, button { padding:10px; margin:10px; border-radius:6px; }
        input { width:300px; }
        button { cursor:pointer; }
        .btn-live { background:#007acc; color:#fff; }
        .btn-features { background:#28a745; color:#fff; }
        .btn-batch { background:#ff7f50; color:#fff; }
        #result, #batch-result { margin-top:20px; padding:20px; background:#2b2b3d; border-radius:10px; width:70%; margin-left:auto; margin-right:auto; text-align:left; }
        #features-box { display:none; text-align:left; width:60%; margin:auto; }
        #batch-upload { display:none; text-align:left; width:60%; margin:auto; }
        input.feature-input { width:100px; margin:3px; }
    </style>
</head>
<body>

<h1>Fusion Meta  – Stock Predictor Dashboard</h1>

<!-- Live Predict -->
<input id="symbol" placeholder="Enter Stock Symbol (AAPL, TSLA, NVDA)" />
<div>
    <button class="btn-live" onclick="livePredict()">Live Predict</button>
    <button class="btn-features" onclick="predictByFeatures()">Predict by Features</button>
    <button class="btn-batch" onclick="showBatchUpload()">Batch Predict</button>
</div>

<!-- Predict by Features -->
<div id="features-box">
    <h3>Enter Feature Values</h3>
    <div id="feature-inputs"></div>
    <button onclick="sendFeaturePredict()">Predict</button>
</div>

<!-- Batch Predict -->
<div id="batch-upload">
    <input type="file" id="csvFile" accept=".csv"/>
    <button onclick="uploadCSV()">Upload csv file & Predict</button>
</div>

<div id="result">Prediction result will appear here.</div>
<div id="batch-result"></div>


<script>

    // Updated feature names (14 features required)
    const featureNames = [
        "open","high","low","close","volume","rsi","vwap",
        "vol_avg","vwap_zone_diff"
    ];

    // Dynamically create feature input fields
    const featureDiv = document.getElementById("feature-inputs");
    featureDiv.innerHTML = "";
    featureNames.forEach(name => {
        const input = document.createElement("input");
        input.className = "feature-input";
        input.id = name;
        input.placeholder = name;
        featureDiv.appendChild(input);
    });

    // Live predict function (unchanged)
    async function livePredict() {
        const symbol = document.getElementById("symbol").value;
        if(!symbol) return;
        const res = await fetch(`/live_predict/${symbol}`);
        const data = await res.json();
        document.getElementById("result").innerText = JSON.stringify(data, null, 2);
    }

    // Auto-refresh every 20 seconds
    setInterval(() => {
        const symbol = document.getElementById("symbol").value;
        if(symbol.trim() !== "") livePredict();
    }, 20000);

    function predictByFeatures() {
        document.getElementById("features-box").style.display = "block";
    }

    function showBatchUpload() {
        document.getElementById("batch-upload").style.display = "block";
    }

    // Predict by features
    async function sendFeaturePredict() {
        const features = {};
        featureNames.forEach(name => {
            features[name] = parseFloat(document.getElementById(name).value) || 0;
        });

        const res = await fetch("/predict", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({features})
        });

        const data = await res.json();
        document.getElementById("result").innerText = JSON.stringify(data, null, 2);
    }

    // Batch predict CSV
async function uploadCSV() {
    const fileInput = document.getElementById("csvFile");
    if(!fileInput.files.length) return alert("Please select a CSV file.");

    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;

        // Parse CSV
        const lines = text.split("\n").filter(l => l.trim() !== "");
        if(lines.length < 2) return alert("CSV must have data rows");

        const headers = lines[0].split(",").map(h => h.trim());
        const rows = [];

        for(let i=1; i<lines.length; i++){
            const cols = lines[i].split(",");
            if(cols.length !== headers.length) continue;

            const row = {};
            headers.forEach((h, idx) => {
                const val = parseFloat(cols[idx]);
                if(!isNaN(val)) row[h] = val;  // only numeric columns
            });
            if(Object.keys(row).length > 0) rows.push(row);
        }

        if(rows.length === 0) return alert("No numeric data found in CSV");

        // Send to backend
        const res = await fetch("/batch_predict", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({rows})
        });

        const data = await res.json();
        document.getElementById("batch-result").innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
    };
    reader.readAsText(fileInput.files[0]);
}
</script>
</body>
</html>
